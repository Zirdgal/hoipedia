<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <link rel="stylesheet" href="../../s.css">



    <title>HoiPedia</title>
</head>
<body>
    <nav>
        <div id="nav-inner">
            <a href="../../index.html">HoiPedia</a>
            <a href="../games.html">Games</a>
            <a href="../players.html">Players</a>
            <a href="../rating.html">Rating</a>
        </div>
    </nav>
    <div>
        <h1 id="name"></h1>
        <h2 id="country">Country:</h2>
        <h2 id="discord">Discord:</h2>
        <h2 id="rating">Rating:<h2>

        <h3 id="recentGames">Recent games played:</h3>
        <table id="gamesTable">
            <thead>
                <tr>
                <th>Name</th>
                <th>Faction Played</th>
                <th>Country Played</th>
                <th>Rating 0.1</th>
                <th>Date</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
    </div>
<script>
    const path = window.location.pathname;
    const fileName = path.substring(path.lastIndexOf('/') + 1);
    const baseName = fileName.replace('.html', '');

    fetch(`../../playerStats/${baseName}.json`)
    .then(res => res.json())
    .then(async playerData => {
        document.getElementById("name").textContent = `${playerData.user}`;
        document.getElementById("country").textContent = `Country: ${playerData.country}`;
        document.getElementById("discord").textContent = `Discord: ${playerData.discord}`;

        let gamesPlayedArray = playerData.gamesPlayed;
        if (!gamesPlayedArray || gamesPlayedArray.length === 0) {
            document.getElementById("recentGames").textContent = "Recent games played: None";
            return;
        }

        // Fetch all game data for games played
        const gameNames = gamesPlayedArray.map(obj => Object.keys(obj)[0]);
        const gameDataArr = await Promise.all(
            gameNames.map(gameName =>
                fetch(`../../gameStats/${gameName}.json`).then(r => r.json()).catch(() => null)
            )
        );

        // Prepare table body
        const tbody = document.querySelector('#gamesTable tbody');
        tbody.innerHTML = ""; // Clear previous

        gameDataArr.forEach((game, idx) => {
            if (!game) return; // skip if fetch failed


            // Find this player's rating for this game
            const thisPlayer = game.players.find(p => p.user === playerData.user);

            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${game.name}</td>
                <td>${thisPlayer.faction}</td>
                <td>${thisPlayer.user} (${thisPlayer.country})</td>
                <td>${thisPlayer ? thisPlayer.rating.toFixed(2) : "N/A"}</td>
                <td>${game.date}</td>
            `;
            // Optional: make row clickable to go to game page
            row.style.cursor = 'pointer';
            row.addEventListener('click', () => {
                window.location.href = game.link3 || game.link2 || game.link;
            });

            tbody.appendChild(row);
        });
    })
    .catch(console.error);
</script>
</body>
</html>